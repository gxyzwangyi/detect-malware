#!/usr/bin/python3

import sqlalchemy, time
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import sessionmaker
from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship, backref
import lxml.html
import urllib.request
import sqlalchemy.exc
from db import APKdata, Downloaded, Base, engine, session, Session

aa = 'http://shouji.baidu.com/software/item?docid='
def extract(a):
    for j in range(1,9):
        c = urllib.request.urlopen("{}&page_num={}".format(a, j))
        b = lxml.html.parse(c)
        for element in b.iter():
            if element.tag == "span":
                g = element.attrib
                if len(g) == 14:
                    aaa = g['data-tj']
                    if aaa[16] == '_':
                        url = (aa+aaa[9:16])
                    elif aaa[15] == '_':
                        url = (aa+aaa[9:15])
                    else:
                        break
                    priority = 1
                    for u in session.query(Downloaded):
                        if u.url == url:
                            priority = 0
                    app_user = APKdata(url, priority, time.time())
                    session.merge(app_user)
                    session.commit()
                    
                   
for i in range(1, 10):
    extract("http://shouji.baidu.com/software/list?cid=50"+str(i))
