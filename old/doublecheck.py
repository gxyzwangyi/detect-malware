#!/usr/bin/python3
from db import APKdata, Downloaded, Base, engine, session, Session, Errors
import os, sqlalchemy.exc, time

listofapps = []
listofdownloaded = []

filename = '/home/coconut/crawler/allapps'
with open(filename, 'r+') as f:
    r = f.readline()
    while r:
        listofapps.append(r[8:48])
        r=f.readline()

for i in session.query(Downloaded):
    listofdownloaded.append(i.sha1)
    if i.sha1 in listofapps:
        listofapps.remove(i.sha1)


for i in listofapps:
    app = '/home/coconut/crawler/apps/{}/'.format(i[0:2])+str(i)+'.apk'
    os.remove(app)
    print('removed app {}'.format(i), flush=True)

for u in session.query(Downloaded).filter(Downloaded.version == 'NA'):
    o = APKdata(u.url, 1, time.time())
    session.add(o)
    try:
        session.commit()
    except sqlalchemy.exc.IntegrityError:
        session.rollback()
        pass
    session.delete(u)
    session.commit()
    print('removed app data {}'.format(u.sha1), flush=True)
    
