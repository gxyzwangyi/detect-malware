
import os
import sys
import re






#预处理阶段-------------------------------------------------------------

# 确定反编译的输出目录，默认是当前apk所属目录
def get_output_folder(_source_apk_path ):
    	if not len( os.path.dirname( _source_apk_path ) ) == 0:
		print os.path.dirname( _source_apk_path ) + '/'
		return os.path.dirname( _source_apk_path ) + '/'
	else:
		return os.path.dirname( _source_apk_path )


# 获取要反编译的apk路径
def get_input_apk_path( ):
	if len( sys.argv ) == 1:
		return raw_input( 'please input the apk\'s path: ' )
	else:
		return sys.argv[ 1 ]



# apktool获取资源文件
def get_resource( _tools_path, _apk_resource_folder, _source_apk_path):
	print '\nGetting resource...'
	os.system('java -jar %s/apktool_2.0.1.jar d -f -o %s %s' % (_tools_path, _apk_resource_folder, _source_apk_path) )



# dex2jar将apk转化为jar
def convert_apk_to_jar( _tools_path, _apk_jar, _source_apk_path):
	print '****Converting apk to jar...'
	os.system( 'sh %s/dex2jar-2.1/d2j-dex2jar.sh -f -o %s %s' % (_tools_path, _apk_jar, _source_apk_path) )


# unzip将class文件从jar包中解压出来
def extract_classes_from_jar(_apk_jar, _apk_classes_folder ):
	print '****Extracting classes from jar...'
	os.system( 'mkdir %s' % _apk_classes_folder )
	os.system( 'unzip -q %s -d %s' % (_apk_jar, _apk_classes_folder) )


# Classyshark读取当前的包名
def get_package_name(_apk_content_folder,_tools_path, _apk_jar ):
	print '****get package from classdex use Classyshark...'
	os.system( 'mkdir %s' % _apk_content_folder )
	os.system( 'java -jar %s/ClassyShark.jar -export %s ' % (_tools_path, _apk_jar) )


# jad将classes文件转换为java代码
def convert_classes_to_java(_apk_source_code_folder,_apk_classes_folder, _tools_path ):
	print '****Converting classes to java code...'
	os.system( 'mkdir %s' % _apk_source_code_folder )
	os.system( 'find %s -name \"*.class\" | xargs %s/jad -ff -r -nonlb -s java -space -d %s >/dev/null 2>&1' % (
		_apk_classes_folder, _tools_path, _apk_source_code_folder) )

# 删除jar和class文件
def delete_tmp_files( _apk_jar,_apk_classes_folder):
	print '****Clean temp files...'
	os.system( 'rmtrash %s' % _apk_jar )
	os.system( 'rmtrash %s' % _apk_classes_folder )