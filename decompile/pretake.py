
import os
import sys
import re






#预处理阶段-------------------------------------------------------------


class pretake_class:
	# 获取要反编译的apk路径
	def __int__(self,_running_path,_tools_path,_source_apk_path,_output_path,_output_folder,_apk_resource_folder,_apk_classes_folder,_apk_source_code_folder,_apk_content_folder,_apk_jar):
    	
		

		self._running_path=_running_path
		self._tools_path=_tools_path
		self._source_apk_path=_source_apk_path
		self._output_path=_output_path
		self._output_folder=_output_folder
		
		self._apk_resource_folder=_apk_resource_folder
		self._apk_classes_folder=_apk_classes_folder
		self._apk_source_code_folder=_apk_source_code_folder
		self._apk_content_folder=_apk_content_folder
		self._apk_jar=_apk_jar
	



	# apktool获取资源文件
	def get_resource(self):
		print '\nGetting resource...'
		os.system('java -jar %s/apktool_2.0.1.jar d -f -o %s %s' % (self._tools_path,self._apk_resource_folder,self._source_apk_path) )



	# dex2jar将apk转化为jar
	def convert_apk_to_jar(self):
		print '****Converting apk to jar...'
		os.system( 'sh %s/dex2jar-2.1/d2j-dex2jar.sh -f -o %s %s' % (self._tools_path,self._apk_jar,self._source_apk_path) )


	# unzip将class文件从jar包中解压出来
	def extract_classes_from_jar(self ):
		print '****Extracting classes from jar...'
		os.system( 'mkdir %s' %self._apk_classes_folder )
		os.system( 'unzip -q %s -d %s' % (self._apk_jar,self._apk_classes_folder) )


	# Classyshark读取当前的包名
	def get_package_name(self ):
		print '****get package from classdex use Classyshark...'
		os.system( 'mkdir %s' %self._apk_content_folder )
		os.system( 'java -jar %s/ClassyShark.jar -export %s ' % (self._tools_path,self._apk_jar) )


	# jad将classes文件转换为java代码
	def convert_classes_to_java(self ):
		print '****Converting classes to java code...'
		os.system( 'mkdir %s' %self._apk_source_code_folder )
		os.system( 'find %s -name \"*.class\" | xargs %s/jad -ff -r -nonlb -s java -space -d %s >/dev/null 2>&1' % (
			self._apk_classes_folder,self._tools_path,self._apk_source_code_folder) )

	# 删除jar和class文件
	def delete_tmp_files(self ):
		print '****Clean temp files...'
		os.system( 'rmtrash %s' %self._apk_jar )
		os.system( 'rmtrash %s' %self._apk_classes_folder )



		# 获取java源码
	def get_source_code(self):
		print '\nGetting source code...'
		self.convert_apk_to_jar( )
		self.extract_classes_from_jar( )
		self.get_package_name( )
		self.convert_classes_to_java( )
		self.delete_tmp_files()


	def get_all(self):
		self.get_resource()
		self.get_source_code()